<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Catur vs AI</title>
    
    <!-- Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        h1 {
            margin-bottom: 10px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 1000px;
            width: 100%;
            position: relative;
        }

        #board {
            width: 100%;
            max-width: 400px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        label {
            font-size: 0.9em;
            margin-bottom: 4px;
            font-weight: bold;
        }

        select, input, button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            align-self: flex-end;
        }

        button:hover {
            background-color: #0056b3;
        }

        .status-panel {
            text-align: center;
            width: 100%;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
        }

        .elo-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
        }

        .game-status {
            margin-top: 5px;
            font-style: italic;
        }

        /* Modal Overlay */
        #loginOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Sidebar Styles */
        .sidebar-right {
            width: 100%;
            border-left: 1px solid #ddd;
            padding-left: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .panel-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
        }
        
        .panel-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
            border-bottom: 1px solid #ddd;
            padding-bottom: 3px;
        }

        .pgn-container {
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            background: white;
            padding: 5px;
        }

        .alert-box {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            display: none; /* Hidden by default */
        }
        
        .hint-box {
            color: #004085;
            background-color: #cce5ff;
            border-color: #b8daff;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            display: none;
        }

        /* Highlight Styles */
        .highlight-last {
            box-shadow: inset 0 0 3px 3px rgba(255, 255, 0, 0.5);
        }
        .highlight-legal {
            box-shadow: inset 0 0 3px 3px rgba(0, 255, 0, 0.5);
        }

        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                align-items: flex-start;
                max-width: 1000px;
            }
            
            .board-container {
                flex: 0 0 400px;
            }

            .sidebar-right {
                flex: 1;
                border-left: 1px solid #ddd;
                border-top: none;
                padding-left: 20px;
                padding-top: 0;
            }
        }
    </style>
</head>
<body>

    <!-- Login Overlay -->
    <div id="loginOverlay">
        <div class="login-box">
            <h2>Selamat Datang!</h2>
            
            <div class="control-group">
                <label for="usernameInput">Username</label>
                <input type="text" id="usernameInput" placeholder="Contoh: Budi123">
            </div>

            <div class="control-group" id="eloInputGroup">
                <label for="initialEloInput">ELO Awal</label>
                <input type="number" id="initialEloInput" value="800">
                <small style="color: #666; font-size: 0.8em;">Isi jika baru pertama kali main.</small>
            </div>

            <div class="control-group" style="flex-direction: row; align-items: center; gap: 8px;">
                <input type="checkbox" id="advisorToggle" style="width: auto;">
                <label for="advisorToggle" style="margin:0;">Aktifkan Saran Langkah (Advisor)</label>
            </div>

            <button id="loginBtn" style="width: 100%;">Masuk & Main</button>
            <div id="loginStatus" style="font-size: 0.8em; color: red;"></div>
        </div>
    </div>

    <h1>Catur vs AI</h1>

    <div class="container">
        <div class="board-container">
            <div id="board"></div>
        </div>

        <div class="sidebar-right">
            
            <div class="status-panel">
                <div>User: <strong id="displayUsername">-</strong></div>
                <div>Rating (ELO): <span id="playerElo" class="elo-display">...</span></div>
                <div id="gameStatus" class="game-status">Siap bermain?</div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label for="aiDifficulty">Tingkat Kesulitan (AI ELO)</label>
                    <input type="number" id="aiDifficulty" value="1200" min="400" max="3000" step="50">
                </div>

                <div class="control-group">
                    <label for="playerColor">Pilih Warna</label>
                    <select id="playerColor">
                        <option value="white">Putih (Jalan Duluan)</option>
                        <option value="black">Hitam</option>
                        <option value="random">Acak</option>
                    </select>
                </div>

                <button id="startBtn">Mulai Game Baru</button>
            </div>

            <!-- New Sidebar Features -->
            <div class="panel-box">
                <div class="panel-title">Riwayat Langkah</div>
                <div id="pgnContainer" class="pgn-container"></div>
            </div>

            <div id="threatAlert" class="alert-box">
                <strong>‚ö†Ô∏è PERINGATAN:</strong>
                <ul id="threatList" style="margin: 5px 0; padding-left: 20px;"></ul>
            </div>

            <div id="advisorPanel" class="hint-box" style="display:none;">
                <button id="btnAskHint" style="width:100%; background:#0056b3; margin-bottom:5px;">üí° Minta Saran (3 Langkah)</button>
                <div id="hintList" style="margin-top:5px; font-weight:bold;"></div>
            </div>
            
            <div style="font-size: 0.9em; color: #666; margin-top: auto;">
                <p><strong>Cara Main:</strong></p>
                <ul>
                    <li>Drag & drop bidak untuk melangkah.</li>
                    <li>Lawan AI rating tinggi = poin naik banyak!</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Audio Elements (Using Online Sources for Simplicity) -->
    <!-- Start: Game Start -->
    <audio id="sndStart" src="https://images.chesscomfiles.com/chess-themes/sounds/_common/default/game-start.mp3"></audio>
    <!-- On: Normal Move -->
    <audio id="sndOn" src="https://images.chesscomfiles.com/chess-themes/sounds/_common/default/move-self.mp3"></audio>
    <!-- Alert: Threat/Check -->
    <audio id="sndAlert" src="https://images.chesscomfiles.com/chess-themes/sounds/_common/default/move-check.mp3"></audio>
    <!-- Boom: Capture -->
    <audio id="sndBoom" src="https://images.chesscomfiles.com/chess-themes/sounds/_common/default/capture.mp3"></audio>
    <!-- End: Checkmate/Game Over -->
    <audio id="sndEnd" src="https://images.chesscomfiles.com/chess-themes/sounds/_common/default/game-end.mp3"></audio>

    <script>
        // --- Globals ---
        var board = null;
        var game = new Chess();
        var $status = $('#gameStatus');
        var $pgnContainer = $('#pgnContainer');
        var playerColor = 'w';
        var stockfish = null;
        var gameActive = false;
        
        var currentUser = null;
        var currentElo = 800;
        var useAdvisor = false;

        // APPS SCRIPT URL
        var APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxBIJBWZ0iPlHE5qkO8f1YDmAwnpqrE7knm9n6LHT_7hGGDXFxOyDg_vpM4VpjT3tiu/exec';

        // --- Audio Logic ---
        function playSound(type) {
            try {
                var audio = null;
                switch(type) {
                    case 'start': audio = document.getElementById('sndStart'); break;
                    case 'on': audio = document.getElementById('sndOn'); break;
                    case 'alert': audio = document.getElementById('sndAlert'); break;
                    case 'boom': audio = document.getElementById('sndBoom'); break;
                    case 'end': audio = document.getElementById('sndEnd'); break;
                }
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("Audio autoplay blocked:", e));
                }
            } catch(e) { console.log('Audio error', e); }
        }

        // --- Highlights ---
        function removeHighlights(className) {
            $('#board .square-55d63').removeClass(className);
        }

        function highlightSquare(square, className) {
            var $square = $('#board .square-' + square);
            if ($square.length === 0) return;
            $square.addClass(className);
        }

        function updateHighlights(history) {
            removeHighlights('highlight-last');
            if (history && history.length > 0) {
                var lastMove = history[history.length - 1];
                highlightSquare(lastMove.from, 'highlight-last');
                highlightSquare(lastMove.to, 'highlight-last');
            }
        }

        // --- Stockfish ---
        var isAnalyzing = false; // Flag to differentiate AI Move vs Hint Analysis

        function initStockfish() {
            var stockfishUrl = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js';
            var blob = new Blob(["importScripts('" + stockfishUrl + "');"], {type: 'application/javascript'});
            stockfish = new Worker(window.URL.createObjectURL(blob));

            stockfish.onmessage = function(event) {
                var line = event.data;
                
                // Handle Analysis (Hints)
                if (isAnalyzing && line.indexOf('pv') > -1 && line.indexOf('info') > -1) {
                    var multipvMatch = line.match(/multipv (\d+)/);
                    var pvMatch = line.match(/ pv ([a-h][1-8][a-h][1-8][qrbn]?)/);
                    
                    if (multipvMatch && pvMatch) {
                        var rank = parseInt(multipvMatch[1]);
                        var bestMove = pvMatch[1];
                        
                        // Convert uci move to readable (e.g. e2e4 -> Pion ke e4)
                        var formattedMove = formatMove(bestMove);
                        
                        // Update UI
                        var $list = $('#hintList');
                        var $item = $list.find('#hint-' + rank);
                        if ($item.length === 0) {
                            $list.append('<div id="hint-' + rank + '">' + rank + '. ' + formattedMove + '</div>');
                        } else {
                            $item.text(rank + '. ' + formattedMove);
                        }
                    }
                }

                if (line.indexOf('bestmove') > -1) {
                    if (isAnalyzing) {
                        isAnalyzing = false;
                        $('#btnAskHint').prop('disabled', false).text('üí° Minta Saran (3 Opsi Langkah)');
                        // Reset options
                        stockfish.postMessage('setoption name MultiPV value 1');
                        return;
                    }

                    // Logic AI Main
                    var turn = game.turn();
                    var aiColor = (playerColor === 'w') ? 'b' : 'w';
                    
                    if (turn === aiColor && gameActive) {
                        var match = line.match(/^bestmove ([a-h][1-8])([a-h][1-8])([qrbn])?/);
                        if (match) {
                            var from = match[1];
                            var to = match[2];
                            var promotion = match[3];
                            
                            var move = game.move({ from: from, to: to, promotion: promotion || 'q' });
                            if (move) {
                                board.position(game.fen());
                                
                                // Sound Logic
                                handleMoveSound(move);

                                updateStatus();
                                
                                if (game.game_over()) handleGameOver();
                            }
                        }
                    }
                }
            };
            
            stockfish.postMessage('uci');
        }
        initStockfish();

        function makeAIMove() {
            if (game.game_over() || !gameActive) return;
            
            isAnalyzing = false;
            var fen = game.fen();
            var elo = parseInt($('#aiDifficulty').val());
            var skillLevel = Math.floor((elo - 400) / (2600 / 20));
            if (skillLevel < 0) skillLevel = 0; 
            if (skillLevel > 20) skillLevel = 20;

            stockfish.postMessage('stop'); // Stop any analysis
            stockfish.postMessage('setoption name Skill Level value ' + skillLevel);
            stockfish.postMessage('setoption name MultiPV value 1'); // Ensure single line
            stockfish.postMessage('position fen ' + fen);
            stockfish.postMessage('go depth 15');
        }

        // --- Hint Logic ---
        $('#btnAskHint').on('click', function() {
            if (isAnalyzing) return;
            
            var turn = game.turn();
            // Ensure it is player's turn
            if (turn !== (playerColor === 'w' ? 'w' : 'b')) return;

            isAnalyzing = true;
            $('#btnAskHint').prop('disabled', true).text('Sedang berpikir...');
            $('#hintList').empty();

            var fen = game.fen();
            
            stockfish.postMessage('stop');
            stockfish.postMessage('setoption name Skill Level value 20');
            stockfish.postMessage('setoption name MultiPV value 3'); // Top 3 moves
            stockfish.postMessage('position fen ' + fen);
            stockfish.postMessage('go depth 12'); // Moderate depth
        });

        function formatMove(uciMove) {
            var from = uciMove.substring(0,2);
            var to = uciMove.substring(2,4);
            // Simple mapping. Ideally use chess.js to get SAN but that requires making the move.
            // Let's try to make temp move to get SAN
            var tempGame = new Chess(game.fen());
            var move = tempGame.move({from: from, to: to, promotion: 'q'});
            return move ? move.san : uciMove;
        }

        // --- Board Logic ---
        function onDragStart (source, piece, position, orientation) {
            if (game.game_over() || !gameActive) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
            if ((playerColor === 'w' && piece.search(/^b/) !== -1) ||
                (playerColor === 'b' && piece.search(/^w/) !== -1)) {
                 return false;
            }

            // Highlight legal moves
            removeHighlights('highlight-legal');
            var moves = game.moves({ square: source, verbose: true });
            
            // Wait slightly for drag to start before adding highlights, otherwise they might be cleared?
            // Or simply add them. 
            for (var i = 0; i < moves.length; i++) {
                highlightSquare(moves[i].to, 'highlight-legal');
            }
            
            return true;
        }
        
        // Add click handler to support tap/click highlighting (mobile friendly or better UX)
        function onMouseoverSquare (square, piece) {
            // Optional: highlight on hover?
            // For now, onDragStart handles drag highlights.
        }

        function onDrop (source, target) {
            removeHighlights('highlight-legal');

            var move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            // Sound Logic
            handleMoveSound(move);

            updateStatus();
            
            if (!game.game_over()) {
                window.setTimeout(makeAIMove, 250);
            } else {
                handleGameOver();
            }
        }

        // --- Sound Helper ---
        function handleMoveSound(move) {
            if (game.game_over()) {
                // Should be handled in handleGameOver? 
                // Wait, handleGameOver calls playSound? No it didn't before.
                // Let's rely on game over trigger.
                return; 
            }
            
            var isCapture = move.flags.includes('c') || move.flags.includes('e');
            
            // Check Threat
            var isThreatening = false;
            // Only check threat if it's not a capture (because capture has own sound)
            // OR priority: Checkmate > Capture > Threat > Normal
            // Actually request was:
            // 2) Normal: "on"
            // 3) Threatening: "alert"
            // 3) Capture: "boom"
            // 4) Checkmate: "end"
            
            if (game.in_checkmate()) {
                // Handled in updateStatus/handleGameOver
            } else if (isCapture) {
                playSound('boom');
            } else if (game.in_check()) {
                playSound('alert');
            } else {
                playSound('on');
            }
        }

        function onSnapEnd () {
            board.position(game.fen());
        }

        // --- Advisor & Analysis ---
        function runAdvisor() {
            if (!useAdvisor) {
                $('#advisorPanel').hide();
                $('#threatAlert').hide();
                return;
            }

            // Show Ask Button
            if (game.turn() === (playerColor === 'w' ? 'w' : 'b')) {
                $('#advisorPanel').show();
                $('#hintList').empty(); // Clear previous hints until asked
            } else {
                $('#advisorPanel').hide();
            }

            // --- Threat Detection ---
            var threats = [];
            if (game.in_check()) {
                threats.push("Raja Anda sedang diserang (Skak)!");
            }

            // Simplified "Direct Threat" from Last Move using Chess.js logic
            var opponentColor = (playerColor === 'w') ? 'b' : 'w';
            
            // Generate valid moves for opponent from current position?
            // No, it's MY turn. To see what opponent attacks, we check their moves as if it were their turn
            // OR simply check if any of my pieces are under attack.
            
            // Hacky but effective in JS without engine:
            // 1. Swap turn to Opponent
            var currentFen = game.fen();
            var tokens = currentFen.split(' ');
            tokens[1] = (tokens[1] === 'w') ? 'b' : 'w'; // Swap active color
            // Strip en passant if not valid? Keep it simple.
            var tempFen = tokens.join(' ');
            
            var tempGame = new Chess(tempFen);
            var opponentMoves = tempGame.moves({ verbose: true });
            
            // Map of squares attacked by opponent
            for (var i=0; i<opponentMoves.length; i++) {
                var m = opponentMoves[i];
                // If move captures something, it means a piece is under attack!
                if (m.flags.includes('c') || m.flags.includes('e')) {
                     var pieceName = getPieceName(m.captured || 'p'); // captured piece
                     var attackerName = getPieceName(m.piece);
                     var threatText = attackerName + " (" + m.from + ") mengancam " + pieceName + " di " + m.to;
                     
                     if (!threats.includes(threatText)) threats.push(threatText);
                }
            }
            
            // Display Threats
            if (threats.length > 0) {
                $('#threatAlert').show();
                $('#threatList').empty();
                threats.forEach(function(t) {
                   $('#threatList').append('<li>' + t + '</li>'); 
                });
            } else {
                $('#threatAlert').hide();
            }
        }
        
        function getPieceName(char) {
            var names = {
                'p': 'Pion',
                'n': 'Kuda',
                'b': 'Gajah',
                'r': 'Benteng',
                'q': 'Menteri',
                'k': 'Raja'
            };
            return names[char.toLowerCase()] || char;
        }

        function updateStatus () {
            var status = '';
            var moveColor = (game.turn() === 'b') ? 'Hitam' : 'Putih';

            if (game.in_checkmate()) {
                status = 'Game Over, ' + moveColor + ' terkena skakmat.';
                playSound('end');
            } else if (game.in_draw()) {
                status = 'Game Over, Remis (Draw).';
                playSound('end');
            } else {
                status = 'Giliran ' + moveColor + ' melangkah';
                if (game.in_check()) status += ', ' + moveColor + ' sedang di-skak!';
            }

            $status.html(status);
            $pgnContainer.html(game.pgn({ max_width: 5, newline_char: '<br />' }));
            
            updateHighlights(game.history({ verbose: true }));
            runAdvisor();
        }

        var config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        }
        
        board = Chessboard('board', config);
        
        // Force resize after render to ensure correct sizing in flex container
        setTimeout(board.resize, 200);

        updateStatus();

        // Handle Resize
        $(window).resize(board.resize);

        // --- Game Flow & ELO System ---
        
        // ELO Logic (LocalStorage + Google Sheets)
        function updateEloDisplay() {
            $('#playerElo').text(currentElo);
        }

        function calculateEloChange(playerElo, opponentElo, result) {
            var K = 32; 
            var expectedScore = 1 / (1 + Math.pow(10, (opponentElo - playerElo) / 400));
            var change = K * (result - expectedScore);
            return change;
        }
        
        // --- Google Sheets Sync ---
        function syncEloToSheet(username, elo) {
            // Using "no-cors" mode for simple submission, but better to use CORS if supported by script.
            // With "ContentService.createTextOutput().setMimeType(JSON)", CORS is usually fine for GET/POST.
            
            var payload = JSON.stringify({
                username: username,
                elo: Math.round(elo)
            });

            // Using simple text/plain to avoid preflight issues if Apps Script isn't perfect.
            // Apps Script doPost needs to parse content.
            
            if (APPS_SCRIPT_URL.indexOf('REPLACE') !== -1) {
                console.log("Apps Script URL not set. Data not synced.");
                return;
            }

            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // 'cors' is better if script handles it correctly. Try 'no-cors' for fire-and-forget.
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow',
                body: payload
            })
            .then(function(response) {
                console.log("Sync initiated.");
            })
            .catch(function(err) {
                console.error("Sync Error:", err);
            });
        }

        function fetchUserElo(username) {
            if (APPS_SCRIPT_URL.indexOf('REPLACE') !== -1) {
                // Mock behavior if URL not set
                var stored = localStorage.getItem('chessPlayerElo_' + username);
                return Promise.resolve(stored ? parseInt(stored) : null);
            }

            return fetch(APPS_SCRIPT_URL + '?action=getElo&username=' + username)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.status === 'found') {
                        return parseInt(data.elo);
                    }
                    return null;
                })
                .catch(function(err) {
                    console.error("Fetch Error:", err);
                    return null; // Fallback
                });
        }

        function handleGameOver() {
            gameActive = false;
            var aiElo = parseInt($('#aiDifficulty').val());
            var resultScore = 0.5; // Draw default
            var resultText = "Remis.";

            if (game.in_checkmate()) {
                var loserColor = game.turn(); // 'w' or 'b'
                if (loserColor === playerColor) {
                    resultScore = 0;
                    resultText = "Anda Kalah!";
                } else {
                    resultScore = 1;
                    resultText = "Anda Menang!";
                }
            } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition()) {
                resultScore = 0.5;
                resultText = "Remis (Draw).";
            }

            var eloChange = calculateEloChange(currentElo, aiElo, resultScore);
            var newElo = currentElo + eloChange;
            
            currentElo = Math.round(newElo);
            updateEloDisplay();
            
            // Save Locally & Cloud
            localStorage.setItem('chessPlayerElo_' + currentUser, currentElo);
            syncEloToSheet(currentUser, currentElo);

            $status.html("<strong>GAME OVER:</strong> " + resultText + " Rating Anda: " + currentElo + " (" + (eloChange >= 0 ? "+" : "") + Math.round(eloChange) + ")");
            alert("Permainan Selesai!\n" + resultText + "\nRating Baru: " + currentElo);
        }

        // --- Login Logic ---
        $('#loginBtn').on('click', function() {
            var username = $('#usernameInput').val().trim();
            var initElo = parseInt($('#initialEloInput').val());
            var advisor = $('#advisorToggle').is(':checked');

            if (!username) {
                $('#loginStatus').text("Username harus diisi!");
                return;
            }

            $('#loginBtn').prop('disabled', true).text('Memuat...');
            
            // Try fetch cloud ELO
            fetchUserElo(username).then(function(cloudElo) {
                if (cloudElo) {
                    currentElo = cloudElo;
                } else {
                    // New User or Offline
                    var local = localStorage.getItem('chessPlayerElo_' + username);
                    currentElo = local ? parseInt(local) : (initElo || 800);
                    
                    // First time sync
                    syncEloToSheet(username, currentElo);
                }

                // Success
                currentUser = username;
                useAdvisor = advisor;
                
                $('#displayUsername').text(currentUser);
                updateEloDisplay();
                
                $('#loginOverlay').fadeOut();
                
                // Show advisor panels if enabled
                if (useAdvisor) {
                    $('.sidebar-right').append('<div style="font-size:0.8em; color:green;">* Advisor Aktif</div>');
                }
            });
        });

        // Start Game Logic
        $('#startBtn').on('click', function() {
            if (!currentUser) {
                alert("Silakan login (refresh halaman) terlebih dahulu.");
                return;
            }

            var colorSelection = $('#playerColor').val();
            
            // Determine Color
            if (colorSelection === 'random') {
                playerColor = Math.random() < 0.5 ? 'w' : 'b';
            } else {
                playerColor = (colorSelection === 'white') ? 'w' : 'b';
            }

            game.reset();
            board.orientation(playerColor === 'w' ? 'white' : 'black');
            board.position('start');
            gameActive = true;
            
            // Clear UI
            $('#pgnContainer').empty();
            $('#threatAlert').hide();
            $('#hintList').empty();
            $('#advisorPanel').hide();
            removeHighlights('highlight-last');
            removeHighlights('highlight-legal');
            
            updateStatus();
            playSound('start');
            $status.html("Permainan dimulai! Anda bermain sebagai: " + (playerColor === 'w' ? 'Putih' : 'Hitam'));

            if (playerColor === 'b') {
                window.setTimeout(makeAIMove, 500);
            }
        });

        // Handle Resize
        $(window).resize(board.resize);
        
        // Initial Resize
        setTimeout(board.resize, 200);

        console.log("Game System Ready.");
    </script>
</body>
</html>