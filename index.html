<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Catur vs AI</title>
    
    <!-- Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        h1 {
            margin-bottom: 10px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 1000px;
            width: 100%;
            position: relative;
        }

        #board {
            width: 100%;
            max-width: 400px;
        }

        /* Captured Pieces Styles */
        .captured-pieces {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            height: 30px;
            width: 100%;
            max-width: 400px;
            background-color: #f0f0f0;
            border-radius: 4px;
            margin-bottom: 5px;
            margin-top: 5px;
            padding: 2px;
            align-items: center;
        }
        .captured-pieces img {
            width: 25px;
            height: 25px;
            margin-right: 2px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            width: 100%;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        label {
            font-size: 0.9em;
            margin-bottom: 4px;
            font-weight: bold;
        }

        select, input, button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            align-self: flex-end;
        }

        button:hover {
            background-color: #0056b3;
        }

        .status-panel {
            text-align: center;
            width: 100%;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
        }

        .elo-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
        }

        .game-status {
            margin-top: 5px;
            font-style: italic;
        }

        /* Modal Overlay */
        #loginOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Sidebar Styles */
        .sidebar-right {
            width: 100%;
            border-left: 1px solid #ddd;
            padding-left: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .panel-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
        }
        
        .panel-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
            border-bottom: 1px solid #ddd;
            padding-bottom: 3px;
        }

        .pgn-container {
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            background: white;
            padding: 5px;
        }

        .alert-box {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            display: none; /* Hidden by default */
        }
        
        .hint-box {
            color: #004085;
            background-color: #cce5ff;
            border-color: #b8daff;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            display: none;
        }

        /* Highlight Styles */
        .highlight-last {
            box-shadow: inset 0 0 3px 3px rgba(255, 255, 0, 0.5);
        }
        .highlight-legal {
            box-shadow: inset 0 0 3px 3px rgba(0, 255, 0, 0.5);
        }

        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                align-items: flex-start;
                max-width: 1000px;
            }
            
            .board-container {
                flex: 0 0 400px;
            }

            .sidebar-right {
                flex: 1;
                border-left: 1px solid #ddd;
                border-top: none;
                padding-left: 20px;
                padding-top: 0;
            }
        }
    </style>
</head>
<body>

    <!-- Login Overlay -->
    <div id="loginOverlay">
        <div class="login-box">
            <h2>Selamat Datang!</h2>
            
            <div class="control-group">
                <label for="usernameInput">Username</label>
                <input type="text" id="usernameInput" placeholder="Contoh: Budi123">
            </div>

            <div class="control-group" id="eloInputGroup">
                <label for="initialEloInput">ELO Awal</label>
                <input type="number" id="initialEloInput" value="800">
                <small style="color: #666; font-size: 0.8em;">Isi jika baru pertama kali main.</small>
            </div>

            <button id="loginBtn" style="width: 100%;">Masuk & Main</button>
            <div id="loginStatus" style="font-size: 0.8em; color: red;"></div>
        </div>
    </div>

    <h1>Catur vs AI</h1>

    <div class="container">
        <div class="board-container">
            <!-- Top Panel: Captured by Opponent (Depends on Orientation) -->
            <div id="capturedTop" class="captured-pieces"></div>
            <div id="board"></div>
            <div id="capturedBottom" class="captured-pieces"></div>
            
            <!-- Advisor Panel (Below Board) -->
            <div id="advisorPanel" class="hint-box" style="display:none; position:relative; margin-top:10px; width:100%;">
                
                <!-- Auto-Hint Checkbox -->
                <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                    <input type="checkbox" id="cbAutoHint">
                    <label for="cbAutoHint" style="font-weight:normal; font-size:0.9em; margin:0; cursor:pointer;">Selalu Tampilkan Saran & Update</label>
                </div>
                
                <!-- Fixed Height Hint Area -->
                <div id="hintArea" style="min-height: 90px; background: white; padding: 5px; border:1px solid #ddd; border-radius: 4px; visibility: hidden;">
                    <strong id="hintTitle" style="display:block; border-bottom:1px solid #eee; margin-bottom:5px; font-size:0.9em;">Opsi Langkah:</strong>
                    <div id="hintList"></div>
                </div>
            </div>
        </div>

        <div class="sidebar-right">
            
            <div class="status-panel">
                <div>User: <strong id="displayUsername">-</strong></div>
                <div>Rating (ELO): <span id="playerElo" class="elo-display">...</span></div>
                <div id="gameStatus" class="game-status">Siap bermain?</div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label for="aiDifficulty">Tingkat Kesulitan (AI ELO)</label>
                    <input type="number" id="aiDifficulty" value="1200" min="400" max="3000" step="50">
                </div>

                <div class="control-group">
                    <label for="playerColor">Pilih Warna</label>
                    <select id="playerColor">
                        <option value="white">Putih (Jalan Duluan)</option>
                        <option value="black">Hitam</option>
                        <option value="random">Acak</option>
                    </select>
                </div>

                <button id="startBtn">Mulai Game Baru</button>
            </div>

            <div class="panel-box">
                <div class="panel-title">Riwayat Langkah</div>
                <div id="pgnContainer" class="pgn-container"></div>
            </div>

            <!-- Static Threat/Opportunity Panel -->
            <div id="threatAlert" class="panel-box" style="display: block;">
                <div id="playerThreatSection">
                    <strong style="color:#721c24;">‚ö†Ô∏è Ancaman (Bahaya)</strong>
                    <ul id="threatListPlayer" style="margin: 5px 0; padding-left: 20px; list-style-type: none; padding:0; min-height: 75px;">
                        <li class="threat-slot" style="padding:2px 0; border-bottom:1px solid #eee;">&nbsp;</li>
                        <li class="threat-slot" style="padding:2px 0; border-bottom:1px solid #eee;">&nbsp;</li>
                        <li class="threat-slot" style="padding:2px 0; border-bottom:1px solid #eee;">&nbsp;</li>
                    </ul>
                </div>
                <div id="aiThreatSection" style="margin-top: 10px; padding-top: 5px; border-top: 1px solid #ddd;">
                    <strong style="color:#155724;">‚öîÔ∏è Peluang (Serang)</strong>
                    <ul id="threatListAI" style="margin: 5px 0; padding-left: 20px; list-style-type: none; padding:0; min-height: 75px;">
                        <li class="opp-slot" style="padding:2px 0; border-bottom:1px solid #eee;">&nbsp;</li>
                        <li class="opp-slot" style="padding:2px 0; border-bottom:1px solid #eee;">&nbsp;</li>
                        <li class="opp-slot" style="padding:2px 0; border-bottom:1px solid #eee;">&nbsp;</li>
                    </ul>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Audio Elements -->
    <audio id="sndStart" src="sounds/start.wav"></audio>
    <audio id="sndOn" src="sounds/on.wav"></audio>
    <audio id="sndAlert" src="sounds/alert.wav"></audio>
    <audio id="sndBoom" src="sounds/boom.wav"></audio>
    <audio id="sndEnd" src="sounds/end.wav"></audio>
    <audio id="sndChime" src="sounds/chime.wav"></audio>

    <script>
        // --- Globals ---
        var board = null;
        var game = new Chess();
        var $status = $('#gameStatus');
        var $pgnContainer = $('#pgnContainer');
        var playerColor = 'w';
        
        // Split Workers
        var gameStockfish = null; 
        var advisorStockfish = null;
        
        var gameActive = false;
        
        var currentUser = null;
        var currentElo = 800;
        var useAdvisor = true; // Always active

        var APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxBIJBWZ0iPlHE5qkO8f1YDmAwnpqrE7knm9n6LHT_7hGGDXFxOyDg_vpM4VpjT3tiu/exec';

        // --- Audio Logic ---
        function playSound(type) {
            try {
                var audio = null;
                switch(type) {
                    case 'start': audio = document.getElementById('sndStart'); break;
                    case 'on': audio = document.getElementById('sndOn'); break;
                    case 'alert': audio = document.getElementById('sndAlert'); break;
                    case 'boom': audio = document.getElementById('sndBoom'); break;
                    case 'end': audio = document.getElementById('sndEnd'); break;
                    case 'chime': audio = document.getElementById('sndChime'); break;
                }
                if (audio) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("Audio autoplay blocked:", e));
                }
            } catch(e) { console.log('Audio error', e); }
        }

        // --- Highlights ---
        function removeHighlights(className) {
            $('#board .square-55d63').removeClass(className);
        }

        function highlightSquare(square, className) {
            var $square = $('#board .square-' + square);
            if ($square.length === 0) return;
            $square.addClass(className);
        }

        function updateHighlights(history) {
            removeHighlights('highlight-last');
            if (history && history.length > 0) {
                var lastMove = history[history.length - 1];
                highlightSquare(lastMove.from, 'highlight-last');
                highlightSquare(lastMove.to, 'highlight-last');
            }
        }

        // --- Stockfish Init ---
        function initStockfishWorkers() {
            var stockfishUrl = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js';
            var blob = new Blob(["importScripts('" + stockfishUrl + "');"], {type: 'application/javascript'});
            var workerUrl = window.URL.createObjectURL(blob);

            // 1. Game AI Worker
            gameStockfish = new Worker(workerUrl);
            gameStockfish.onmessage = function(event) {
                var line = event.data;
                // Handle Bestmove (AI Move)
                if (line.indexOf('bestmove') > -1) {
                    handleAIBestMove(line);
                }
            };
            gameStockfish.postMessage('uci');

            // 2. Advisor Worker
            advisorStockfish = new Worker(workerUrl);
            advisorStockfish.onmessage = function(event) {
                var line = event.data;
                
                // Handle MultiPV (Hints)
                if (line.indexOf('pv') > -1 && line.indexOf('info') > -1) {
                    var multipvMatch = line.match(/multipv (\d+)/);
                    var pvMatch = line.match(/ pv ([a-h][1-8][a-h][1-8][qrbn]?)/);
                    
                    if (multipvMatch && pvMatch) {
                        var rank = parseInt(multipvMatch[1]);
                        var bestMove = pvMatch[1];
                        var formatted = formatMoveHTML(bestMove);
                        
                        var $list = $('#hintList');
                        var $item = $list.find('#hint-' + rank);
                        if ($item.length === 0) {
                            $list.append('<div id="hint-' + rank + '" style="display:flex; align-items:center; margin-bottom:4px;">' + rank + '. ' + formatted + '</div>');
                        } else {
                            $item.html(rank + '. ' + formatted);
                        }
                        
                        $('#hintArea').css('visibility', 'visible');
                    }
                }
            };
            advisorStockfish.postMessage('uci');
        }
        initStockfishWorkers();

        // --- Game AI Logic ---
        function makeAIMove() {
            if (game.game_over() || !gameActive) return;
            
            var fen = game.fen();
            var elo = parseInt($('#aiDifficulty').val());
            var skillLevel = Math.floor((elo - 400) / (2600 / 20));
            if (skillLevel < 0) skillLevel = 0; 
            if (skillLevel > 20) skillLevel = 20;

            gameStockfish.postMessage('stop'); 
            gameStockfish.postMessage('setoption name Skill Level value ' + skillLevel);
            gameStockfish.postMessage('setoption name MultiPV value 1'); 
            gameStockfish.postMessage('position fen ' + fen);
            gameStockfish.postMessage('go depth 15');
        }

        function handleAIBestMove(line) {
            // Logic AI Main
            var turn = game.turn();
            var aiColor = (playerColor === 'w') ? 'b' : 'w';
            
            if (turn === aiColor && gameActive) {
                var match = line.match(/^bestmove ([a-h][1-8])([a-h][1-8])([qrbn])?/);
                if (match) {
                    var from = match[1];
                    var to = match[2];
                    var promotion = match[3];
                    
                    var move = game.move({ from: from, to: to, promotion: promotion || 'q' });
                    if (move) {
                        board.position(game.fen());
                        handleMoveSound(move);
                        updateStatus();
                        updateCapturedPieces();
                        if (game.game_over()) handleGameOver();
                    }
                }
            }
        }

        // --- Hint / Advisor Logic ---
        
        // Shared Function to request analysis
        function updateHints() {
             var fen = game.fen();
             $('#hintList').empty(); // Clear old hints
             
             // Update Header
             var turnColor = (game.turn() === 'w') ? 'Putih' : 'Hitam';
             $('#hintTitle').text('Opsi Langkah (' + turnColor + '):');
             
             advisorStockfish.postMessage('stop');
             advisorStockfish.postMessage('setoption name Skill Level value 20'); // Max strength for hints
             advisorStockfish.postMessage('setoption name MultiPV value 3'); // Top 3
             advisorStockfish.postMessage('position fen ' + fen);
             advisorStockfish.postMessage('go depth 12');
        }

        // Checkbox Listener
        $('#cbAutoHint').on('change', function() {
            var isChecked = $(this).is(':checked');
            if (isChecked) {
                // Enabled: Update immediately
                updateHints();
            } else {
                // Disabled: Hide area
                $('#hintArea').css('visibility', 'hidden');
                advisorStockfish.postMessage('stop');
            }
        });

        function formatMoveHTML(uciMove) {
            var from = uciMove.substring(0,2);
            var to = uciMove.substring(2,4);
            var tempGame = new Chess(game.fen());
            var move = tempGame.move({from: from, to: to, promotion: 'q'});
            if (!move) return uciMove;
            var pieceType = move.piece; 
            var pieceColor = move.color;
            var imgUrl = 'https://chessboardjs.com/img/chesspieces/wikipedia/' + pieceColor + pieceType.toUpperCase() + '.png';
            return '<img src="' + imgUrl + '" style="width:20px; height:20px; margin-right:4px;"> ' + move.san;
        }

        // --- Board Logic ---
        function onDragStart (source, piece, position, orientation) {
            if (game.game_over() || !gameActive) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
            if ((playerColor === 'w' && piece.search(/^b/) !== -1) ||
                (playerColor === 'b' && piece.search(/^w/) !== -1)) {
                 return false;
            }
            removeHighlights('highlight-legal');
            var moves = game.moves({ square: source, verbose: true });
            for (var i = 0; i < moves.length; i++) {
                highlightSquare(moves[i].to, 'highlight-legal');
            }
            return true;
        }

        function onDrop (source, target) {
            removeHighlights('highlight-legal');
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            handleMoveSound(move);
            updateStatus();
            updateCapturedPieces(); 
            
            if (!game.game_over()) {
                window.setTimeout(makeAIMove, 250);
            } else {
                handleGameOver();
            }
        }

        function handleMoveSound(move) {
            if (game.game_over()) return; 
            var isCapture = move.flags.includes('c') || move.flags.includes('e');
            if (game.in_checkmate()) { } 
            else if (isCapture) playSound('boom');
            else if (game.in_check()) playSound('alert');
            else playSound('on');
        }

        function onSnapEnd () {
            board.position(game.fen());
            updateCapturedPieces();
        }

        // --- Captured Pieces Logic ---
        function updateCapturedPieces() {
            var history = game.history({ verbose: true });
            
            var capturedWhite = []; // Pieces belonging to White that were captured
            var capturedBlack = []; // Pieces belonging to Black that were captured
            
            for (var i=0; i<history.length; i++) {
                var m = history[i];
                if (m.flags.includes('c') || m.flags.includes('e')) {
                    if (m.color === 'w') {
                        // White moved and captured Black piece
                        capturedBlack.push(m.captured); 
                    } else {
                        // Black moved and captured White piece
                        capturedWhite.push(m.captured);
                    }
                }
            }
            
            var orientation = board.orientation(); // 'white' or 'black'
            
            if (orientation === 'white') {
                renderCaptured('#capturedTop', capturedWhite, 'w'); 
                renderCaptured('#capturedBottom', capturedBlack, 'b'); 
            } else {
                renderCaptured('#capturedTop', capturedBlack, 'b');
                renderCaptured('#capturedBottom', capturedWhite, 'w');
            }
        }
        
        function renderCaptured(selector, pieces, colorPrefix) {
            var $container = $(selector);
            $container.empty();
            var order = ['q','r','b','n','p'];
            pieces.sort(function(a,b) { return order.indexOf(a) - order.indexOf(b); });
            pieces.forEach(function(p) {
                var imgUrl = 'https://chessboardjs.com/img/chesspieces/wikipedia/' + colorPrefix + p.toUpperCase() + '.png';
                $container.append('<img src="' + imgUrl + '">');
            });
        }

        // --- Advisor & Analysis (Threats) ---
        function getPieceValue(type) {
            var values = {p:1, n:3, b:3, r:5, q:9, k:100};
            return values[type] || 0;
        }

        function getRecapturer(fen, fromSquare, toSquare) {
            var tempGame = new Chess();
            try { tempGame.load(fen); } catch(e) { return null; }
            var piece = tempGame.get(fromSquare);
            if (!piece) return null;
            var attackerColor = piece.color;
            var tokens = tempGame.fen().split(' ');
            tokens[1] = attackerColor;
            tempGame.load(tokens.join(' '));
            var move = tempGame.move({from: fromSquare, to: toSquare, promotion: 'q'});
            if (!move) return null; 
            var victimMoves = tempGame.moves({verbose: true});
            for (var i=0; i<victimMoves.length; i++) {
                if (victimMoves[i].to === toSquare) return victimMoves[i].piece; 
            }
            return null;
        }

        function getAttackers(fen, square, attackerColor) {
            var attackers = [];
            var tempGame = new Chess();
            var tokens = fen.split(' ');
            tokens[1] = attackerColor;
            var tempFen = tokens.join(' ');
            try { tempGame.load(tempFen); } catch(e) { return []; }
            var moves = tempGame.moves({verbose: true});
            for(var i=0; i<moves.length; i++) {
                if (moves[i].to === square) attackers.push({ from: moves[i].from, type: moves[i].piece });
            }
            return attackers;
        }

        function runThreatAnalysis() {
            // Always show panel
            $('#advisorPanel').show();
            $('#threatAlert').show();
            
            var playerThreats = []; 
            var aiThreats = []; 
            
            if (game.in_check()) {
                if (game.turn() === playerColor) playerThreats.push({val: 1000, text: "‚ö†Ô∏è RAJA ANDA SEDANG DISERANG (SKAK)!"});
                else aiThreats.push({val: 1000, text: "üî• RAJA LAWAN SEDANG DISERANG (SKAK)!"});
            }

            var currentFen = game.fen();
            var boardState = game.board();
            var opponentColor = (playerColor === 'w') ? 'b' : 'w';
            
            var playChime = false; // Flag to play sound

            for(var r=0; r<8; r++) {
                for(var c=0; c<8; c++) {
                    var piece = boardState[r][c];
                    if (piece) {
                        var sq = String.fromCharCode(97+c) + (8-r);
                        if (piece.color === playerColor) {
                            var attackers = getAttackers(currentFen, sq, opponentColor);
                            if (attackers.length > 0) {
                                // Logic for Chime Sound: 
                                // 1. Threat to Queen 
                                // 2. Threat to any Undefended piece
                                
                                var minAttackerVal = 999;
                                var minAttackerType = '';
                                var attackerSquare = '';
                                attackers.forEach(function(a) {
                                    var val = getPieceValue(a.type);
                                    if (val < minAttackerVal) { minAttackerVal = val; minAttackerType = a.type; attackerSquare = a.from; }
                                });
                                var pieceName = getPieceName(piece.type);
                                var attackerName = getPieceName(minAttackerType);
                                var defenderType = getRecapturer(currentFen, attackerSquare, sq);

                                if (!defenderType) {
                                    // Undefended -> CHIME
                                    playChime = true;
                                    playerThreats.push({val: 100, text: "‚ö†Ô∏è " + pieceName + " di " + sq + " GRATIS ditangkap " + attackerName + "! (analisis awal)"});
                                } else {
                                    // Defended
                                    if (piece.type === 'q') {
                                        // Threat to Queen (Defended) -> CHIME
                                        playChime = true;
                                    }
                                    var myVal = getPieceValue(piece.type);
                                    var attVal = getPieceValue(minAttackerType);
                                    var defenderName = getPieceName(defenderType);
                                    if (attVal < myVal) playerThreats.push({val: 80, text: "‚ö†Ô∏è BAHAYA: " + pieceName + " ("+myVal+") diancam " + attackerName + " ("+attVal+") meski dilindungi " + defenderName + "."});
                                    else playerThreats.push({val: 10, text: "üõ°Ô∏è " + pieceName + " di " + sq + " diancam " + attackerName + ", tapi terlindungi " + defenderName + "."});
                                }
                            }
                        }
                        if (piece.color === opponentColor) {
                            var attackers = getAttackers(currentFen, sq, playerColor);
                            if (attackers.length > 0) {
                                var minAttackerVal = 999;
                                var minAttackerType = '';
                                var attackerSquare = '';
                                attackers.forEach(function(a) {
                                    var val = getPieceValue(a.type);
                                    if (val < minAttackerVal) { minAttackerVal = val; minAttackerType = a.type; attackerSquare = a.from; }
                                });
                                var pieceName = getPieceName(piece.type);
                                var attackerName = getPieceName(minAttackerType); 
                                var defenderType = getRecapturer(currentFen, attackerSquare, sq);

                                if (!defenderType) {
                                    aiThreats.push({val: 100, text: "üî• " + pieceName + " lawan di " + sq + " GRATIS untuk ditangkap! (analisis awal)"});
                                } else {
                                    var enemyVal = getPieceValue(piece.type);
                                    var myVal = getPieceValue(minAttackerType);
                                    var defenderName = getPieceName(defenderType);
                                    if (enemyVal > myVal) aiThreats.push({val: 90, text: "‚ö° UNTUNG: Tukar " + attackerName + " ("+myVal+") dengan " + pieceName + " ("+enemyVal+") meski dijaga " + defenderName + "."});
                                    else aiThreats.push({val: 10, text: "üõ°Ô∏è " + pieceName + " lawan di " + sq + " bisa ditangkap " + attackerName + ", tapi terlindungi " + defenderName + "."});
                                }
                            }
                        }
                    }
                }
            }
            
            // Only play chime if it's Player's turn (i.e. opponent just moved creating the threat)
            if (playChime && game.turn() === playerColor && !game.in_checkmate()) {
                playSound('chime');
            }

            function renderFixedList(list, selector, color) {
                list.sort(function(a,b) { return b.val - a.val; });
                var $ul = $(selector);
                $ul.empty();
                for(var i=0; i<3; i++) {
                    var content = "&nbsp;";
                    if (i < list.length) content = list[i].text;
                    var style = "padding:2px 0; border-bottom:1px solid #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.85em; color: " + color + ";";
                    $ul.append('<li style="' + style + '">' + content + '</li>');
                }
            }
            renderFixedList(playerThreats, '#threatListPlayer', '#721c24'); 
            renderFixedList(aiThreats, '#threatListAI', '#155724'); 
        }
        
        function getPieceName(char) {
            var names = { 'p': 'Pion', 'n': 'Kuda', 'b': 'Gajah', 'r': 'Benteng', 'q': 'Menteri', 'k': 'Raja' };
            return names[char.toLowerCase()] || char;
        }

        function updateStatus () {
            var status = '';
            var moveColor = (game.turn() === 'b') ? 'Hitam' : 'Putih';

            if (game.in_checkmate()) {
                status = 'Game Over, ' + moveColor + ' terkena skakmat.';
                playSound('end');
            } else if (game.in_draw()) {
                status = 'Game Over, Remis (Draw).';
                playSound('end');
            } else {
                status = 'Giliran ' + moveColor + ' melangkah';
                if (game.in_check()) status += ', ' + moveColor + ' sedang di-skak!';
            }

            $status.html(status);
            $pgnContainer.html(game.pgn({ max_width: 5, newline_char: '<br />' }));
            
            updateHighlights(game.history({ verbose: true }));
            runThreatAnalysis();
            
            // Auto Hint Logic
            if ($('#cbAutoHint').is(':checked')) {
                updateHints();
            }
        }

        var config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        }
        
        board = Chessboard('board', config);
        setTimeout(board.resize, 200);
        updateStatus();
        $(window).resize(board.resize);

        // --- ELO & Google Sheets ---
        function updateEloDisplay() { $('#playerElo').text(currentElo); }
        function calculateEloChange(playerElo, opponentElo, result) {
            var K = 32; 
            var expectedScore = 1 / (1 + Math.pow(10, (opponentElo - playerElo) / 400));
            return K * (result - expectedScore);
        }
        
        function syncEloToSheet(username, elo) {
            var payload = JSON.stringify({ username: username, elo: Math.round(elo) });
            if (APPS_SCRIPT_URL.indexOf('REPLACE') !== -1) return;
            fetch(APPS_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors', cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                redirect: 'follow', body: payload
            }).catch(e => console.error("Sync Error:", e));
        }

        function fetchUserElo(username) {
            if (APPS_SCRIPT_URL.indexOf('REPLACE') !== -1) {
                var stored = localStorage.getItem('chessPlayerElo_' + username);
                return Promise.resolve(stored ? parseInt(stored) : null);
            }
            return fetch(APPS_SCRIPT_URL + '?action=getElo&username=' + username)
                .then(r => r.json())
                .then(data => (data.status === 'found') ? parseInt(data.elo) : null)
                .catch(e => null);
        }

        function handleGameOver() {
            gameActive = false;
            var aiElo = parseInt($('#aiDifficulty').val());
            var resultScore = 0.5; 
            var resultText = "Remis.";

            if (game.in_checkmate()) {
                var loserColor = game.turn(); 
                if (loserColor === playerColor) { resultScore = 0; resultText = "Anda Kalah!"; } 
                else { resultScore = 1; resultText = "Anda Menang!"; }
            } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition()) {
                resultScore = 0.5; resultText = "Remis (Draw).";
            }

            var eloChange = calculateEloChange(currentElo, aiElo, resultScore);
            currentElo = Math.round(currentElo + eloChange);
            updateEloDisplay();
            localStorage.setItem('chessPlayerElo_' + currentUser, currentElo);
            syncEloToSheet(currentUser, currentElo);
            $status.html("<strong>GAME OVER:</strong> " + resultText + " Rating Anda: " + currentElo + " (" + (eloChange >= 0 ? "+" : "") + Math.round(eloChange) + ")");
            alert("Permainan Selesai!\n" + resultText + "\nRating Baru: " + currentElo);
        }

        // --- Login Logic ---
        $('#loginBtn').on('click', function() {
            var username = $('#usernameInput').val().trim();
            var initElo = parseInt($('#initialEloInput').val());
            // Advisor always active
            var advisor = true;

            if (!username) { $('#loginStatus').text("Username harus diisi!"); return; }
            $('#loginBtn').prop('disabled', true).text('Memuat...');
            
            fetchUserElo(username).then(function(cloudElo) {
                if (cloudElo) currentElo = cloudElo;
                else {
                    var local = localStorage.getItem('chessPlayerElo_' + username);
                    currentElo = local ? parseInt(local) : (initElo || 800);
                    syncEloToSheet(username, currentElo);
                }
                currentUser = username;
                useAdvisor = advisor;
                $('#displayUsername').text(currentUser);
                updateEloDisplay();
                $('#loginOverlay').fadeOut();
                if (useAdvisor) $('.sidebar-right').append('<div style="font-size:0.8em; color:green;">* Advisor Aktif</div>');
            });
        });

        // Start Game
        $('#startBtn').on('click', function() {
            if (!currentUser) { alert("Silakan login (refresh halaman) terlebih dahulu."); return; }
            var colorSelection = $('#playerColor').val();
            if (colorSelection === 'random') playerColor = Math.random() < 0.5 ? 'w' : 'b';
            else playerColor = (colorSelection === 'white') ? 'w' : 'b';

            game.reset();
            board.orientation(playerColor === 'w' ? 'white' : 'black');
            board.position('start');
            gameActive = true;
            
            $('#pgnContainer').empty();
            $('#threatAlert').hide();
            // Hints reset
            $('#hintList').empty();
            if (!$('#cbAutoHint').is(':checked')) $('#hintArea').css('visibility', 'hidden');

            removeHighlights('highlight-last');
            removeHighlights('highlight-legal');
            
            updateStatus();
            $status.html("Permainan dimulai! Anda bermain sebagai: " + (playerColor === 'w' ? 'Putih' : 'Hitam'));

            if (playerColor === 'b') window.setTimeout(makeAIMove, 500);
        });

        $(window).resize(board.resize);
        setTimeout(board.resize, 200);
        console.log("Game System Ready (Auto-Hint Enabled).");
    </script>
</body>
</html>