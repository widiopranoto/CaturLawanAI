<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catur vs AI</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ôüÔ∏è</text></svg>">
    
    <!-- Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        h1 {
            margin-bottom: 20px;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-weight: 800;
            font-size: 2.5em;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            max-width: 1000px;
            width: 100%;
            position: relative;
            backdrop-filter: blur(10px);
        }

        #board {
            width: 100%;
            max-width: 400px;
            border: 5px solid #4a5568;
            border-radius: 4px;
        }

        /* Captured Pieces Styles */
        .captured-pieces {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            height: 35px;
            width: 100%;
            max-width: 400px;
            background-color: #edf2f7;
            border-radius: 8px;
            margin-bottom: 8px;
            margin-top: 8px;
            padding: 4px;
            align-items: center;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .captured-pieces img {
            width: 28px;
            height: 28px;
            margin-right: 2px;
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.3));
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            width: 100%;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
            min-width: 120px;
        }

        label {
            font-size: 0.9em;
            margin-bottom: 6px;
            font-weight: 700;
            color: #4a5568;
        }

        select, input, button {
            padding: 10px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1em;
            font-family: 'Nunito', sans-serif;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s;
        }
        
        input:focus, select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        button {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: auto;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.3);
        }
        
        button:disabled {
            background: #cbd5e0;
            transform: none;
            cursor: not-allowed;
        }

        .status-panel {
            text-align: center;
            width: 100%;
            padding: 15px;
            background: #f7fafc;
            border-radius: 12px;
            border: 1px solid #edf2f7;
            margin-bottom: 15px;
        }

        .elo-display {
            font-size: 1.3em;
            font-weight: 800;
            color: #38a169;
        }

        .game-status {
            margin-top: 8px;
            font-style: italic;
            color: #718096;
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .alert-popup {
            background: white;
            padding: 25px;
            border-radius: 16px;
            width: 320px;
            text-align: center;
            border: 4px solid #e53e3e;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .close-icon {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #718096;
            cursor: pointer;
            line-height: 1;
        }
        .close-icon:hover {
            color: #e53e3e;
        }
        
        .elo-guide {
            font-size: 0.85em;
            background: #ebf8ff;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
            color: #2c5282;
            margin-top: -10px;
        }
        
        .elo-guide table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }
        
        .elo-guide td {
            padding: 2px 0;
        }

        .sidebar-right {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .panel-box {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .panel-title {
            font-weight: 800;
            margin-bottom: 10px;
            color: #2d3748;
            border-bottom: 2px solid #edf2f7;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pgn-container {
            height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #f7fafc;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #edf2f7;
        }

        .hint-box {
            background: linear-gradient(to right, #ebf8ff, #fff);
            border: 1px solid #bee3f8;
            padding: 15px;
            border-radius: 12px;
            font-size: 0.95em;
        }

        /* Highlight Styles */
        .highlight-last {
            box-shadow: inset 0 0 3px 3px rgba(255, 215, 0, 0.6);
        }
        .highlight-legal {
            box-shadow: inset 0 0 3px 3px rgba(102, 126, 234, 0.5);
        }

        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                align-items: flex-start;
            }
            .board-container { flex: 0 0 400px; }
            .sidebar-right { flex: 1; padding-left: 20px; }
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .checkbox-wrapper input { width: auto; cursor: pointer; }
        .checkbox-wrapper span { font-size: 0.9em; color: #4a5568; font-weight: 600; }
        .hint-reason { font-size: 0.85em; color: #718096; margin-left: 5px; font-style: italic; }
    </style>
</head>
<body>

    <!-- Login Overlay -->
    <div id="loginOverlay" class="modal-overlay" style="display:flex;">
        <div class="login-box">
            <h2 style="text-align:center; margin-bottom:10px; color:#4a5568;">üéÆ Mulai Main!</h2>
            
            <div class="control-group">
                <label for="usernameInput">Username</label>
                <input type="text" id="usernameInput" placeholder="Misal: JagoanCatur123">
            </div>

            <!-- Game Mode Selector -->
            <div class="control-group">
                <label for="modeSelect">Pilih Mode</label>
                <select id="modeSelect">
                    <option value="PvAI">Pemain vs AI</option>
                    <option value="AIvAI">AI vs AI</option>
                </select>
            </div>

            <div class="control-group" id="eloInputGroup">
                <label for="initialEloInput">Rating Awal</label>
                <input type="number" id="initialEloInput" value="500">
            </div>
            
            <div class="elo-guide">
                <strong>Panduan Rating ELO:</strong>
                <table>
                    <tr><td>üë∂ SD</td><td>: 400 - 600</td></tr>
                    <tr><td>üë¶ SMP</td><td>: 600 - 800</td></tr>
                    <tr><td>üßë SMA</td><td>: 800 - 1000</td></tr>
                    <tr><td>üéì Mahasiswa</td><td>: 1000 - 1200</td></tr>
                    <tr><td>üë® Dewasa (Hobi)</td><td>: 1200 - 1400</td></tr>
                    <tr><td>üèÜ Professional</td><td>: 2000+</td></tr>
                    <tr><td>üëë Grand Master</td><td>: 2500+</td></tr>
                </table>
            </div>

            <button id="loginBtn" style="width: 100%; padding: 12px; font-size:1.1em;">üöÄ Masuk & Main</button>
            <div id="loginStatus" style="font-size: 0.9em; color: #e53e3e; text-align:center;"></div>
        </div>
    </div>

    <!-- Queen Alert Overlay -->
    <div id="queenAlertOverlay" class="modal-overlay">
        <div class="alert-popup">
            <div id="closeAlertX" class="close-icon">&times;</div>
            <div style="font-size: 3em; margin-bottom: 10px;">‚ö†Ô∏è</div>
            <h2 style="color:#e53e3e; margin:0;">AWAS!</h2>
            <p style="font-size:1.2em; margin: 15px 0; color: #2d3748; font-weight: 600;">Menteri Anda sedang diancam!</p>
            <p style="font-size:0.9em; color: #718096; margin-bottom: 0;">Selamatkan menterimu sebelum terlambat.</p>
        </div>
    </div>

    <h1>‚ôüÔ∏è Catur vs AI is Fun</h1>

    <div class="container">
        <div class="board-container">
            <!-- Top Panel -->
            <div id="capturedTop" class="captured-pieces"></div>
            <div id="board"></div>
            <div id="capturedBottom" class="captured-pieces"></div>
            
            <!-- Advisor Panel -->
            <div id="advisorPanel" class="hint-box" style="display:none; position:relative; margin-top:10px; width:100%;">
                <div class="checkbox-wrapper" style="margin-bottom: 10px;">
                    <input type="checkbox" id="cbAutoHint" checked>
                    <span>Tampilkan Saran & Update</span>
                </div>
                <div id="hintArea" style="min-height: 90px; background: white; padding: 10px; border:2px solid #bee3f8; border-radius: 8px; visibility: hidden;">
                    <strong id="hintTitle" style="display:block; border-bottom:1px solid #e2e8f0; margin-bottom:5px; font-size:0.9em; color:#2b6cb0;">Opsi Langkah:</strong>
                    <div id="hintList"></div>
                </div>
            </div>
        </div>

        <div class="sidebar-right">
            
            <div class="status-panel">
                <div>Mode: <strong id="displayMode" style="color:#553c9a;">...</strong></div>
                <div>Pemain: <strong id="displayUsername" style="color:#553c9a;">-</strong></div>
                <div>Rating (ELO): <span id="playerElo" class="elo-display">...</span></div>
                <div id="gameStatus" class="game-status">Siap bermain?</div>
            </div>

            <div class="controls">
                <!-- PvAI Controls -->
                <div id="pvaiControls">
                     <div class="control-group">
                        <label for="aiDifficulty">Level AI (Lawan)</label>
                        <input type="number" id="aiDifficulty" value="1200" min="400" max="3000" step="50">
                    </div>
    
                    <div class="control-group">
                        <label for="playerColor">Warna Bidak Anda</label>
                        <select id="playerColor">
                            <option value="white">Putih (Jalan Dulu)</option>
                            <option value="black">Hitam</option>
                            <option value="random">Acak</option>
                        </select>
                    </div>
                </div>

                <!-- AI v AI Controls -->
                <div id="aivaiControls" style="display:none; width: 100%;">
                    <div class="control-group" style="width:100%;">
                        <label>Rating AI Putih</label>
                        <input type="number" id="aiWhiteEloInput" value="1200" step="50" style="margin-bottom:10px;">
                    </div>
                    <div class="control-group" style="width:100%;">
                        <label>Rating AI Hitam</label>
                        <input type="number" id="aiBlackEloInput" value="1200" step="50">
                    </div>
                </div>

                <button id="startBtn">üî• Mulai Game!</button>
            </div>

            <!-- Threat Panel -->
            <div id="threatAlert" class="panel-box" style="display: block;">
                <div id="playerThreatSection">
                    <strong style="color:#c53030;">‚ö†Ô∏è Ancaman (Bahaya)</strong>
                    <ul id="threatListPlayer" style="margin: 5px 0; padding-left: 20px; list-style-type: none; padding:0; min-height: 75px;">
                        <li class="threat-slot" style="padding:2px 0; border-bottom:1px solid #edf2f7;">&nbsp;</li>
                        <li class="threat-slot" style="padding:2px 0; border-bottom:1px solid #edf2f7;">&nbsp;</li>
                        <li class="threat-slot" style="padding:2px 0; border-bottom:1px solid #edf2f7;">&nbsp;</li>
                    </ul>
                </div>
                <div id="aiThreatSection" style="margin-top: 10px; padding-top: 5px; border-top: 2px dashed #e2e8f0;">
                    <strong style="color:#2f855a;">‚öîÔ∏è Peluang (Serang)</strong>
                    <ul id="threatListAI" style="margin: 5px 0; padding-left: 20px; list-style-type: none; padding:0; min-height: 75px;">
                        <li class="opp-slot" style="padding:2px 0; border-bottom:1px solid #edf2f7;">&nbsp;</li>
                        <li class="opp-slot" style="padding:2px 0; border-bottom:1px solid #edf2f7;">&nbsp;</li>
                        <li class="opp-slot" style="padding:2px 0; border-bottom:1px solid #edf2f7;">&nbsp;</li>
                    </ul>
                </div>
            </div>

            <div class="panel-box">
                <div class="panel-title">
                    <span>üìú Riwayat Langkah</span>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="cbShowHistory" checked>
                        <span style="font-size:0.8em; font-weight:normal;">Tampilkan</span>
                    </div>
                </div>
                <div id="pgnContainer" class="pgn-container"></div>
            </div>
            
        </div>
    </div>
    
    <!-- Audio Elements -->
    <audio id="sndStart" src="sounds/start.wav"></audio>
    <audio id="sndOn" src="sounds/on.wav"></audio>
    <audio id="sndAlert" src="sounds/alert.wav"></audio>
    <audio id="sndBoom" src="sounds/boom.wav"></audio>
    <audio id="sndEnd" src="sounds/end.wav"></audio>
    <audio id="sndChime" src="sounds/chime.wav"></audio>

    <script>
        // --- Global Variables ---
        var board = null;
        var game = new Chess();
        var playerColor = 'w';
        var gameMode = 'PvAI'; // 'PvAI' or 'AIvAI'
        var aiWhiteElo = 1200;
        var aiBlackElo = 1200;
        
        var gameStockfish = null; 
        var advisorStockfish = null;
        var gameActive = false;
        var currentUser = null;
        var currentElo = 800;
        var useAdvisor = true;
        var queenAlertShownForTurn = -1;

        var APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxBIJBWZ0iPlHE5qkO8f1YDmAwnpqrE7knm9n6LHT_7hGGDXFxOyDg_vpM4VpjT3tiu/exec';

        // --- Core Functions (Global Scope) ---

        function playSound(type) {
            try {
                var audio = null;
                switch(type) {
                    case 'start': audio = document.getElementById('sndStart'); break;
                    case 'on': audio = document.getElementById('sndOn'); break;
                    case 'alert': audio = document.getElementById('sndAlert'); break;
                    case 'boom': audio = document.getElementById('sndBoom'); break;
                    case 'end': audio = document.getElementById('sndEnd'); break;
                    case 'chime': audio = document.getElementById('sndChime'); break;
                }
                if (audio) {
                    audio.currentTime = 0;
                    var playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(function(error) { console.log("Audio error/blocked: " + error); });
                    }
                }
            } catch(e) { console.log('Audio error', e); }
        }

        function getPieceValue(type) { var values = {p:1, n:3, b:3, r:5, q:9, k:100}; return values[type] || 0; }
        function getPieceName(char) { var names = { 'p': 'Pion', 'n': 'Kuda', 'b': 'Gajah', 'r': 'Benteng', 'q': 'Menteri', 'k': 'Raja' }; return names[char.toLowerCase()] || char; }

        // --- Stockfish ---
        function initStockfishWorkers() {
            var stockfishUrl = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js';
            var blob = new Blob(["importScripts('" + stockfishUrl + "');"], {type: 'application/javascript'});
            var workerUrl = window.URL.createObjectURL(blob);

            gameStockfish = new Worker(workerUrl);
            gameStockfish.onmessage = function(event) {
                var line = event.data;
                if (line.indexOf('bestmove') > -1) {
                    handleAIBestMove(line);
                }
            };
            gameStockfish.postMessage('uci');

            advisorStockfish = new Worker(workerUrl);
            advisorStockfish.onmessage = function(event) {
                var line = event.data;
                if (line.indexOf('pv') > -1 && line.indexOf('info') > -1) {
                    var scoreMatch = line.match(/score (cp|mate) (-?\d+)/);
                    var scoreType = scoreMatch ? scoreMatch[1] : 'cp';
                    var scoreVal = scoreMatch ? parseInt(scoreMatch[2]) : 0;
                    var multipvMatch = line.match(/multipv (\d+)/);
                    var pvMatch = line.match(/ pv ([a-h][1-8][a-h][1-8][qrbn]?)/);
                    
                    if (multipvMatch && pvMatch) {
                        var rank = parseInt(multipvMatch[1]);
                        var bestMove = pvMatch[1];
                        var formatted = formatMoveHTML(bestMove);
                        var reason = getHintReason(bestMove, scoreType, scoreVal);
                        var $list = $('#hintList');
                        var $item = $list.find('#hint-' + rank);
                        var htmlContent = '<div id="hint-' + rank + '" style="display:flex; align-items:center; margin-bottom:4px; font-weight:600; color:#2d3748;">' + rank + '. ' + formatted + '<span class="hint-reason">(' + reason + ')</span></div>';
                        if ($item.length === 0) $list.append(htmlContent);
                        else $item.html(rank + '. ' + formatted + '<span class="hint-reason">(' + reason + ')</span>');
                        $('#hintArea').css('visibility', 'visible');
                    }
                }
            };
            advisorStockfish.postMessage('uci');
        }

        function makeAIMove() {
            if (game.game_over() || !gameActive) return;
            
            var turn = game.turn();
            var fen = game.fen();
            var eloToUse = 1200;
            
            // Determine if we should move
            if (gameMode === 'PvAI') {
                if (playerColor === 'w' && turn === 'w') return;
                if (playerColor === 'b' && turn === 'b') return;
                eloToUse = parseInt($('#aiDifficulty').val());
            } else {
                // AI vs AI
                if (turn === 'w') eloToUse = aiWhiteElo;
                else eloToUse = aiBlackElo;
            }

            var skillLevel = Math.floor((eloToUse - 400) / (2600 / 20));
            if (skillLevel < 0) skillLevel = 0; if (skillLevel > 20) skillLevel = 20;

            gameStockfish.postMessage('stop'); 
            gameStockfish.postMessage('setoption name Skill Level value ' + skillLevel);
            gameStockfish.postMessage('setoption name MultiPV value 1'); 
            gameStockfish.postMessage('position fen ' + fen);
            gameStockfish.postMessage('go depth 15');
        }

        function handleAIBestMove(line) {
            // Check if it IS AI turn
            var turn = game.turn();
            var isAITurn = false;
            if (gameMode === 'AIvAI') isAITurn = true;
            else {
                if (playerColor === 'w' && turn === 'b') isAITurn = true;
                if (playerColor === 'b' && turn === 'w') isAITurn = true;
            }

            if (isAITurn && gameActive) {
                var match = line.match(/^bestmove ([a-h][1-8])([a-h][1-8])([qrbn])?/);
                if (match) {
                    var from = match[1];
                    var to = match[2];
                    var promotion = match[3];
                    var move = game.move({ from: from, to: to, promotion: promotion || 'q' });
                    if (move) {
                        board.position(game.fen());
                        handleMoveSound(move);
                        updateStatus();
                        updateCapturedPieces();
                        if (!game.game_over()) {
                             if (gameMode === 'AIvAI') {
                                 // Trigger next move with delay
                                 setTimeout(makeAIMove, 1000);
                             }
                        } else {
                            handleGameOver();
                        }
                    }
                }
            }
        }
        
        function handleMoveSound(move) {
            if (game.in_check()) playSound('alert');
            else if (move.flags.includes('c') || move.flags.includes('e')) playSound('boom');
            else playSound('on');
        }
        
        function handleGameOver() {
             gameActive = false;
             updateStatus();
        }

        // --- Fetch ELO Global ---
        function fetchUserElo(username) {
            if (APPS_SCRIPT_URL.indexOf('REPLACE') !== -1) {
                var stored = localStorage.getItem('chessPlayerElo_' + username);
                return Promise.resolve(stored ? parseInt(stored) : null);
            }
            return fetch(APPS_SCRIPT_URL + '?action=getElo&username=' + username)
                .then(function(r) { return r.json(); })
                .then(function(data) { return (data.status === 'found') ? parseInt(data.elo) : null; })
                .catch(function(e) { return null; });
        }
        
        function syncEloToSheet(username, elo) {
            var payload = JSON.stringify({ username: username, elo: Math.round(elo) });
            if (APPS_SCRIPT_URL.indexOf('REPLACE') !== -1) return;
            fetch(APPS_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors', cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                redirect: 'follow', body: payload
            }).catch(function(e) { console.error("Sync Error:", e); });
        }

        // --- Helpers ---
        function formatMoveHTML(uciMove) {
            var from = uciMove.substring(0,2);
            var to = uciMove.substring(2,4);
            var tempGame = new Chess(game.fen());
            var move = tempGame.move({from: from, to: to, promotion: 'q'});
            if (!move) return uciMove;
            var pieceType = move.piece; var pieceColor = move.color;
            var imgUrl = 'https://chessboardjs.com/img/chesspieces/wikipedia/' + pieceColor + pieceType.toUpperCase() + '.png';
            return '<img src="' + imgUrl + '" style="width:20px; height:20px; margin-right:4px;"> ' + move.san;
        }

        function getHintReason(uciMove, scoreType, scoreVal) {
            var tempGame = new Chess(game.fen());
            var from = uciMove.substring(0,2);
            var to = uciMove.substring(2,4);
            var move = tempGame.move({from: from, to: to, promotion: 'q'});
            if (!move) return "Langkah legal";
            var reasons = [];
            if (move.san.includes('#')) return "Skakmat lawan!";
            if (move.san.includes('+')) reasons.push("Skak Raja");
            if (move.flags.includes('c') || move.flags.includes('e')) {
                var captured = getPieceName(move.captured || 'p');
                if (move.flags.includes('e')) captured = "Pion";
                reasons.push("Menangkap " + captured);
            }
            if (move.flags.includes('p')) reasons.push("Promosi bidak");
            if (scoreType === 'mate') { if (scoreVal > 0) reasons.push("Menuju kemenangan"); else reasons.push("Bertahan dari skakmat"); }
            else { if (scoreVal > 200) reasons.push("Posisi dominan"); else if (scoreVal > 50) reasons.push("Keunggulan posisi"); }
            return reasons.length > 0 ? reasons.join(", ") : "Langkah strategis";
        }

        function getRecapturer(fen, fromSquare, toSquare) { 
            var tempGame = new Chess(); 
            try { tempGame.load(fen); } catch(e) { return null; } 
            var piece = tempGame.get(fromSquare); 
            if (!piece) return null; 
            var attackerColor = piece.color; 
            var tokens = tempGame.fen().split(' '); 
            tokens[1] = attackerColor; 
            tempGame.load(tokens.join(' ')); 
            var move = tempGame.move({from: fromSquare, to: toSquare, promotion: 'q'}); 
            if (!move) return null; 
            var victimMoves = tempGame.moves({verbose: true}); 
            for (var i=0; i<victimMoves.length; i++) { if (victimMoves[i].to === toSquare) return victimMoves[i].piece; } 
            return null; 
        }

        function getAttackers(fen, square, attackerColor) { 
            var attackers = []; var tempGame = new Chess(); var tokens = fen.split(' '); tokens[1] = attackerColor; var tempFen = tokens.join(' '); 
            try { tempGame.load(tempFen); } catch(e) { return []; } 
            var moves = tempGame.moves({verbose: true}); 
            for(var i=0; i<moves.length; i++) { if (moves[i].to === square) attackers.push({ from: moves[i].from, type: moves[i].piece }); } 
            return attackers; 
        }

        function runThreatAnalysis() {
            $('#advisorPanel').show(); $('#threatAlert').show();
            var playerThreats = []; var aiThreats = [];
            if (game.in_check()) { if (game.turn() === playerColor) playerThreats.push({val: 1000, text: "RAJA ANDA DISERANG!"}); else aiThreats.push({val: 1000, text: "RAJA LAWAN DISERANG!"}); }
            
            var currentFen = game.fen(); var boardState = game.board(); var opponentColor = (playerColor === 'w') ? 'b' : 'w';
            var playChime = false; var queenThreatened = false;

            for(var r=0; r<8; r++) { for(var c=0; c<8; c++) { var piece = boardState[r][c]; if (piece) { var sq = String.fromCharCode(97+c) + (8-r);
                if (piece.color === playerColor) {
                    var attackers = getAttackers(currentFen, sq, opponentColor);
                    if (attackers.length > 0) {
                        var minAttacker = attackers[0]; // Simplified for brevity
                        var defender = getRecapturer(currentFen, minAttacker.from, sq);
                        var pieceName = getPieceName(piece.type); var attName = getPieceName(minAttacker.type);
                        if (!defender) { playChime = true; playerThreats.push({val: 100, text: "‚ö†Ô∏è " + pieceName + " GRATIS ditangkap " + attName}); if (piece.type === 'q') queenThreatened = true; }
                        else { if (piece.type === 'q') { playChime = true; queenThreatened = true; } playerThreats.push({val: 10, text: pieceName + " diancam " + attName}); }
                    }
                }
                if (piece.color === opponentColor) {
                     var attackers = getAttackers(currentFen, sq, playerColor);
                     if (attackers.length > 0) {
                         var minAttacker = attackers[0]; 
                         var defender = getRecapturer(currentFen, minAttacker.from, sq);
                         var pieceName = getPieceName(piece.type);
                         if (!defender) aiThreats.push({val: 100, text: "üî• " + pieceName + " GRATIS ditangkap!"});
                     }
                }
            }}}

            if (gameMode === 'PvAI' && game.turn() === playerColor && !game.in_checkmate()) {
                if (playChime) playSound('chime');
                var currentMoveCount = game.history().length;
                if (queenThreatened && queenAlertShownForTurn !== currentMoveCount) {
                    $('#queenAlertOverlay').css('display', 'flex').hide().fadeIn();
                    queenAlertShownForTurn = currentMoveCount;
                }
            }
            
            function renderList(list, id, color) { 
                var $ul = $(id); $ul.empty(); list.sort((a,b) => b.val - a.val);
                for(var i=0;i<3;i++) { var t = list[i]?list[i].text:'&nbsp;'; $ul.append('<li style="padding:2px 0; border-bottom:1px solid #eee; color:'+color+'">'+t+'</li>'); }
            }
            renderList(playerThreats, '#threatListPlayer', '#c53030');
            renderList(aiThreats, '#threatListAI', '#2f855a');
        }
        
        function updateHints() {
             var fen = game.fen();
             $('#hintList').empty(); 
             var turnColor = (game.turn() === 'w') ? 'Putih' : 'Hitam';
             $('#hintTitle').text('Opsi Langkah (' + turnColor + '):');
             advisorStockfish.postMessage('stop');
             advisorStockfish.postMessage('setoption name Skill Level value 20'); 
             advisorStockfish.postMessage('setoption name MultiPV value 3'); 
             advisorStockfish.postMessage('position fen ' + fen);
             advisorStockfish.postMessage('go depth 12');
        }

        function updateStatus() {
            var status = ''; var moveColor = (game.turn() === 'b') ? 'Hitam' : 'Putih';
            if (game.in_checkmate()) { status = 'Game Over, ' + moveColor + ' terkena skakmat.'; playSound('end'); }
            else if (game.in_draw()) { status = 'Game Over, Remis.'; playSound('end'); }
            else { status = 'Giliran ' + moveColor; if (game.in_check()) status += ' (SKAK!)'; }
            
            $('#gameStatus').html(status);
            $('#pgnContainer').html(game.pgn({max_width:5, newline_char:'<br/>'}));
            removeHighlights('highlight-last'); 
            var hist = game.history({verbose:true});
            if (hist.length > 0) { var last = hist[hist.length-1]; highlightSquare(last.from, 'highlight-last'); highlightSquare(last.to, 'highlight-last'); }
            
            updateCapturedPieces();
            runThreatAnalysis();
            if ($('#cbAutoHint').is(':checked')) updateHints();
        }

        function updateEloDisplay() { $('#playerElo').text(currentElo); }
        
        function removeHighlights(className) {
            $('#board .square-55d63').removeClass(className);
        }

        function highlightSquare(square, className) {
            var $square = $('#board .square-' + square);
            if ($square.length === 0) return;
            $square.addClass(className);
        }
        
        function updateCapturedPieces() {
            var history = game.history({ verbose: true });
            var capturedWhite = []; var capturedBlack = []; 
            for (var i=0; i<history.length; i++) {
                var m = history[i];
                if (m.flags.includes('c') || m.flags.includes('e')) {
                    if (m.color === 'w') capturedBlack.push(m.captured); 
                    else capturedWhite.push(m.captured);
                }
            }
            var orientation = board.orientation(); 
            if (orientation === 'white') {
                renderCaptured('#capturedTop', capturedWhite, 'w'); 
                renderCaptured('#capturedBottom', capturedBlack, 'b'); 
            } else {
                renderCaptured('#capturedTop', capturedBlack, 'b');
                renderCaptured('#capturedBottom', capturedWhite, 'w');
            }
        }
        
        function renderCaptured(selector, pieces, colorPrefix) {
            var $container = $(selector);
            $container.empty();
            var order = ['q','r','b','n','p'];
            pieces.sort(function(a,b) { return order.indexOf(a) - order.indexOf(b); });
            pieces.forEach(function(p) {
                var imgUrl = 'https://chessboardjs.com/img/chesspieces/wikipedia/' + colorPrefix + p.toUpperCase() + '.png';
                $container.append('<img src="' + imgUrl + '">');
            });
        }
        
        // --- Board Interaction Logic (Global) ---
        function onDragStart (source, piece, position, orientation) {
            if (game.game_over() || !gameActive) return false;
            // AI vs AI -> No interaction
            if (gameMode === 'AIvAI') return false;
            
            // Player vs AI
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
            if ((playerColor === 'w' && piece.search(/^b/) !== -1) ||
                (playerColor === 'b' && piece.search(/^w/) !== -1)) {
                 return false;
            }
            // Block interaction if Alert is visible
            if ($('#queenAlertOverlay').is(':visible')) return false;

            removeHighlights('highlight-legal');
            var moves = game.moves({ square: source, verbose: true });
            for (var i = 0; i < moves.length; i++) {
                highlightSquare(moves[i].to, 'highlight-legal');
            }
            return true;
        }

        function onDrop (source, target) {
            removeHighlights('highlight-legal');
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            handleMoveSound(move);
            updateStatus();
            updateCapturedPieces(); 
            
            if (!game.game_over()) {
                window.setTimeout(makeAIMove, 250);
            } else {
                handleGameOver();
            }
        }

        function onSnapEnd () {
            board.position(game.fen());
            updateCapturedPieces();
        }

        // --- jQuery Document Ready ---
        $(function() {
            // Initialize Board
            var cfg = {
                draggable: true,
                position: 'start',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            board = Chessboard('board', cfg);
            $(window).resize(function(){ if(board) board.resize(); });
            setTimeout(function(){ if(board) board.resize(); }, 200);

            initStockfishWorkers();

            // Event Listeners
            $('#closeAlertX').on('click', function() { $('#queenAlertOverlay').fadeOut(); });
            $('#cbAutoHint').on('change', function() { if($(this).is(':checked')) updateHints(); else { $('#hintArea').css('visibility','hidden'); advisorStockfish.postMessage('stop'); } });
            $('#cbShowHistory').on('change', function() { $(this).is(':checked') ? $('#pgnContainer').show() : $('#pgnContainer').hide(); });

            $('#loginBtn').on('click', function() {
                var user = $('#usernameInput').val();
                if (!user) { $('#loginStatus').text("Username wajib!"); return; }
                $('#loginBtn').prop('disabled', true).text("Memuat...");
                
                gameMode = $('#modeSelect').val();
                if (gameMode === 'AIvAI') {
                    $('#displayMode').text("AI vs AI");
                    $('#pvaiControls').hide(); $('#aivaiControls').show(); $('#playerEloContainer').hide();
                } else {
                    $('#displayMode').text("Pemain vs AI");
                    $('#pvaiControls').show(); $('#aivaiControls').hide(); $('#playerEloContainer').show();
                }

                fetchUserElo(user).then(function(elo) {
                     if(elo) currentElo = elo; 
                     else { currentElo = parseInt($('#initialEloInput').val()) || 500; syncEloToSheet(user, currentElo); }
                     currentUser = user;
                     $('#displayUsername').text(user);
                     updateEloDisplay();
                     $('#loginOverlay').css('display','none');
                     if(useAdvisor) $('.sidebar-right').append('<div style="font-size:0.8em; color:green; text-align:center;">* Advisor Aktif</div>');
                });
            });

            $('#startBtn').on('click', function() {
                 if (!currentUser) { alert("Login dulu!"); return; }
                 if (gameMode === 'AIvAI') {
                     aiWhiteElo = parseInt($('#aiWhiteEloInput').val());
                     aiBlackElo = parseInt($('#aiBlackEloInput').val());
                 }
                 
                 var colorVal = $('#playerColor').val();
                 if (gameMode === 'PvAI') {
                     if (colorVal === 'random') playerColor = Math.random() < 0.5 ? 'w' : 'b';
                     else playerColor = (colorVal === 'white') ? 'w' : 'b';
                 } else {
                     playerColor = 'spectator';
                 }

                 game.reset();
                 board.orientation(playerColor === 'b' ? 'black' : 'white');
                 board.position('start');
                 gameActive = true;
                 queenAlertShownForTurn = -1;
                 
                 $('#pgnContainer').empty(); $('#hintList').empty();
                 updateStatus();
                 
                 if (gameMode === 'PvAI') {
                     if (playerColor === 'b') setTimeout(makeAIMove, 500);
                 } else {
                     // AI vs AI start
                     setTimeout(makeAIMove, 500);
                 }
            });
        });
    </script>
</body>
</html>